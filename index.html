<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>LCLS Status</title>
		<meta name="author" content="Matt Gibbs">
		<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<link href="cud.css" rel="stylesheet">
		<script src="d3/d3.v3.min.js"></script>
	</head>
	<body>
		<div class="container">
			<div class="row">
				<div class="span10">
					<div class="page-header">
						<h1>LCLS Linac Status</h1>
					</div>
					<div class="row">
						<div class="span2">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>Machine Rate</h4>
							</div>
							<h1 class="bigfont"><span id="machineRate" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO467"></span></h1>
						</div>
						<div class="span2">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>Bunch Charge</h4>
							</div>
							<h1 class="bigfont"><span id="bunchCharge" class="PVmonitor" data-pv="SIOC:SYS0:ML00:CALC997"></span></h1>
						</div>
						<div class="span6">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>L3 Energy</h4>
							</div>
							<h1 class="bigfont"><span id="L3Energy" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO500" data-precision="3"></span><span id="L3Vernier" data-pv="FBCK:FB04:LG01:DL2VERNIER" data-units="" data-precision="1"></span></h1>
						</div>
					</div>
					<div class="row">
						<div class="span10">
							
							<table class="table" id="emittanceTable">
								<thead>
									<tr>
										<th></th>
										<th>X Emittance / Bmag</th>
										<th>Y Emittance / Bmag</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<th>OTR-2</th>
										<td><span id="OTR2XEmit" class="emittanceValue" data-pv="OTRS:IN20:571:EMITN_X" data-precision="2" data-units=""></span> / <span id="OTR2XMatch" class="matchingValue" data-pv="OTRS:IN20:571:BMAG_X" data-precision="2" data-units=""></span></td>
										<td><span id="OTR2YEmit" class="emittanceValue" data-pv="OTRS:IN20:571:EMITN_Y" data-precision="2" data-units=""></span> / <span id="OTR2YMatch" class="matchingValue" data-pv="OTRS:IN20:571:BMAG_Y" data-precision="2" data-units=""></span></td>
									</tr>
									<tr>
										<th>WS12</th>
										<td><span id="WS12XEmit" class="emittanceValue" data-pv="WIRE:LI21:293:EMITN_X" data-precision="2" data-units=""></span> / <span id="WS12XMatch" class="matchingValue" data-pv="WIRE:LI21:293:BMAG_X" data-precision="2" data-units=""></span></td>
										<td><span id="WS12YEmit" class="emittanceValue" data-pv="WIRE:LI21:293:EMITN_Y" data-precision="2" data-units=""></span> / <span id="WS12YMatch" class="matchingValue" data-pv="WIRE:LI21:293:BMAG_Y" data-precision="2" data-units=""></span></td>
									</tr>
									<tr>
										<th>LI28</th>
										<td><span id="LI28XEmit" class="emittanceValue" data-pv="WIRE:LI28:144:EMITN_X" data-precision="2" data-units=""></span> / <span id="LI28XMatch" class="matchingValue" data-pv="WIRE:LI28:144:BMAG_X" data-precision="2" data-units=""></span></td>
										<td><span id="LI28YEmit" class="emittanceValue" data-pv="WIRE:LI28:144:EMITN_Y" data-precision="2" data-units=""></span> / <span id="LI28YMatch" class="matchingValue" data-pv="WIRE:LI28:144:BMAG_Y" data-precision="2" data-units=""></span></td>
									</tr>
									<tr>
										<th>LTU</th>
										<td><span id="LTUXEmit" class="emittanceValue" data-pv="WIRE:LTU1:735:EMITN_X" data-precision="2" data-units=""></span> / <span id="LTUXMatch" class="matchingValue" data-pv="WIRE:LTU1:735:BMAG_X" data-precision="2" data-units=""></span></td>
										<td><span id="LTUYEmit" class="emittanceValue" data-pv="WIRE:LTU1:735:EMITN_Y" data-precision="2" data-units=""></span> / <span id="LTUYMatch" class="matchingValue" data-pv="WIRE:LTU1:735:BMAG_Y" data-precision="2" data-units=""></span></td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
					<div class="row">
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>BC1 Peak Current</h4>
							</div>
							<h1><span id="BC1PeakCurrent" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO485"></span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>L1S Phase</h4>
							</div>
							<h1><span id="L1SPhase" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO479" data-units="&deg" data-precision="1"></span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>BC1 Energy</h4>
							</div>
							<h1><span id="BC1Energy" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO483"></span></h1>
						</div>
					</div>
					<div class="row">
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>BC2 Peak Current</h4>
							</div>
							<h1><span id="BC2PeakCurrent" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO195"></span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>L2 Phase</h4>
							</div>
							<h1><span id="L2Phase"  class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO487" data-units="&deg" data-precision="1"></span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>BC2 Energy</h4>
							</div>
							<h1><span id="BC2Energy" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO489" data-precision="1"></span></h1>
						</div>
					</div>
				</div>
				<div class="span9 offset1"><!-- FEL Status -->
					<div class="page-header">
						<h1>FEL Status</h1>
					</div>
					<div class="row">
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>FEL Pulse Energy</h4>
							</div>
							<h1 class="bigfont"><span id="GDETEnergy" class="PVmonitor" data-pv="SIOC:SYS0:ML00:CALC000" data-precision="1"></span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>Photon Energy</h4>
							</div>
							<h1 class="bigfont"><span id="photonEnergy" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO627" data-precision="1"></span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>Scheduled User</h4>
							</div>
							<h1 class="bigfont"><span id="scheduledUser" class="PVmonitor" data-pv="SIOC:SYS0:ML01:SO0085" data-units="" data-updatetime="20000"></span></h1>
						</div>
					</div>
					<div class="row">
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>Pulse Length</h4>
							</div>
							<h1><span id="pulseLength" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO820"></span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>Energy Loss</h4>
							</div>
							<h1><span id="eLoss" class="PVmonitor" data-pv="SIOC:SYS0:ML00:AO556"></span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>Amplification Mode</h4>
							</div>
							<h1><span id="amplificationMode" data-pv="SIOC:SYS0:ML00:CALC998" data-units=""></span></h1>
						</div>
					</div>
					
					<div class="page-header" style="padding-top: 30px">
						<h1>Performance Statistics</h1>
					</div>
					<div class="row">
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>Photon Availability</h4>
							</div>
							<h1 class="bigfont"><span id="photonAvailability" class="PVmonitor" data-pv="SIOC:SYS0:ML01:AO086" data-units="%"></span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>Historic Max Energy</h4>
							</div>
							<h1 class="bigfont"><span id="maxEnergy" class="PVmonitor" data-pv="SIOC:SYS0:ML01:AO080"></span></h1>
						</div>
						<div class="span3">
							<div class="page-header" style="padding-bottom:2px; margin-bottom:12px;">
								<h4>Historic Mean Energy</h4>
							</div>
							<h1 class="bigfont"><span id="meanEnergy" class="PVmonitor" data-pv="SIOC:SYS0:ML01:AO081"></span></h1>
						</div>
					</div>
					<div class="row">
						<div class="span9">
							<h2 id="abortMessage">BYKICK aborting every <span class="PVmonitor" id="abortRate" data-pv="IOC:IN20:EV01:BYKIK_ABTPRD" data-units=""></span> pulses.</h2>
							<h2 id="burstMessage">Burst Mode is enabled, users requesting <span class="PVmonitor" id="burstRate" data-pv="EVNT:SYS0:1:LCLSBURSRATE"></span>.</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="row"><!-- graph row begin -->
				<div class="span20" id="history">
					<div class="page-header">
						<h1>24 Hour History</h1>
					</div>
					<script>
						var margin = {top: 20, right: 20, bottom: 20, left: 40};
						var width = document.getElementById('history').offsetWidth - margin.left - margin.right;
						var height = 180 - margin.top - margin.bottom;
						
						var x = d3.time.scale().range([0,width]);
						
						var y = d3.scale.linear().range([height,0]);
						
						var color = d3.scale.category10();
						
						var xAxis = d3.svg.axis().scale(x).orient("bottom");
						var yAxis = d3.svg.axis().scale(y).orient("left");
						
						var line = d3.svg.line().interpolate("basis")
																		.x(function(d) { return x(d.date); })
																		.y(function(d) { return y(d.value); });
																		
						var area = d3.svg.area().interpolate("basis")
																		.x(function(d) { return x(d.date); })
																		.y0(height)
																		.y1(function(d) { return y(d.value); });
																		
						var svg = d3.select("#history").append("svg")
												.attr("width", width + margin.left + margin.right)
												.attr("height", height + margin.top + margin.bottom)
											.append("g")
												.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
												
						var xAxisElement = svg.append("g")
								.attr("class", "x axis")
								.attr("transform", "translate(0," + height + ")");
						
						var yAxisElement = svg.append("g").attr("class", "y axis")
						
						yAxisElement.append("text")
													.attr("transform", "rotate(-90)")
													.attr("y", -40)
													.attr("dy", ".71em")
													.style("text-anchor", "end")
													.text("Pulse Energy (mJ)");
						
						var count = 400;
						var updateTimeout;
						function updateData() {
							clearTimeout(updateTimeout);
							console.log("Refreshing history graph.");
							d3.json("http://lcls-prod03.slac.stanford.edu:8888/history?PV=GDET:FEE1:241:ENRC&style=4&count=" + count, function(error, data) {
								if (error) {
									updateTimeout = setTimeout(updateData,24*60*60*1000/count);
									return console.warn(error);
								}
								
								color.domain(["Gas Detector"]);

								data.forEach(function(d) { 
									d.date = new Date(d.timestamp*1000); 
								});

								var traces = color.domain().map(function(name) {
									return {
										name: name,
										values: data.map(function(d) { return { date: d.date, value: +d.value };
										})
									};
								});

								x.domain(d3.extent(data, function(d) { return d.date; }));
								y.domain([
								    d3.min(traces, function(t) { return d3.min(t.values, function(v) { return v.value; }); }),
								    d3.max(traces, function(t) { return d3.max(t.values, function(v) { return v.value; }); })
								  ]);

								var trace = svg.selectAll(".trace").data(traces);

								var newTrace = trace.enter().append("g").attr("class","trace")
								var areaPath = newTrace.append("path")
											.attr("class", "area")
											.attr("d", function(d) { return area(d.values); })
											.style("fill", function(d) { return d3.hsl(color(d.name)).darker(1); });															
								var linePath = newTrace.append("path")
											.attr("class", "line")
											.attr("d", function(d) { return line(d.values); })
											.style("stroke", function(d) { return color(d.name); });						

								var updateTransition = trace.transition().duration(1000);
								updateTransition.select(".area").attr("d", function(d) { return area(d.values); });
								updateTransition.select(".line").attr("d", function(d) { return line(d.values); });

								trace.exit().remove();

								xAxisElement.call(xAxis);

								yAxisElement.call(yAxis);
								
								updateTimeout = setTimeout(updateData,24*60*60*1000/count);
							});
						}
						updateTimeout = setTimeout(updateData,10000);										
					</script>
				</div>
			</div><!-- graph row end -->	
		</div><!-- container end -->
	</body>
	<script src="webPV-HTTP.js"></script>
</html>